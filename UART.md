# 串口通信

## 概念

串行接口是一种可以将接收来自CPU的并行数据字符转换为连续的串行数据流发送出去，同时可将接收的串行数据流转换为并行的数据字符供给CPU的器件。一般完成这种功能的电路，我们称为串行接口电路。

串口通信（Serial Communications）的概念非常简单，串口按位（bit）发送和接收字节的通信方式。

## 必要知识

在学习串口通信之前，需要先学习以下知识：

### 电平

串口之间通信使用电平来进行转换为信号。

普通的串口通讯电平分为 【TTL电平】与【COMS电平】

> 【TTL电平】：由双极晶体管构成，只能在平稳的电压中运行，通常为5V下工作。其中 0V = 逻辑0，5V = 逻辑1。
>
>  ![](E:\JavaLeaningDoc\picture\2023-9-24 20-34-16.png)
>
> 【CMOS电平】：由场效应管构成，逻辑电平范围比较大，通常范围在3V-15V之间。其中 0V = 逻辑0，高电平接近器件电源电压 = 逻辑1。
>
> ![](E:\JavaLeaningDoc\picture\2023-9-24 20-38-9.png)

除了以上2种电平之外，还有RS XXX 电平，这个下面介绍。



### 传输类型

串口传输类型通常分为：单端传输 与 差分传输

> 单端传输：由参考地端和信号端构成。单端信号是在 一根导线 上传输的与地之间的电平差。 优点是成本低，简单方便。缺点是地线噪音影响通信，抗干扰能力差。
>
> ![](E:\JavaLeaningDoc\picture\2023-9-24 20-49-25.png)
>
> 差分传输：是在两根线上传输两个振幅相等，相位相反的信号。差分信号的抗干扰能力强，能有效抑制电磁干扰【EMI】。使用两根线的差值来获取数据。
>
> ![](E:\JavaLeaningDoc\picture\2023-9-24 20-50-4.png)

### 传输方向

串口传输通常用RX 表示 接收（receive），TX 表示发送（transport）。

### 串口数据

**串口传输时，首先要约定好”帧格式“和”波特率“。**



**帧格式 定义着 没一帧的串口数据的格式。**

下面是常见的以**10bit帧格式** 的 一帧串口数据：

![](E:\JavaLeaningDoc\picture\2023-9-24 20-58-20.png)

其中第一个位为 "起始位" **以低电平开始** ,最后一位为"停止位" **以高电平结束**。

中间这些位 为数据位，数据位中由左到右，**第一个数据位为 LSB（最低位），最后一个为MSB（最高位）**。



**波特率 ，表示在一秒之内的串口可以传输的高低电平的数量。**常见有9600、19200、38400等等。



## 常见串口类型

目前常见的串口通信类型有：

串口、RS232 、 RS485、RS422。

它们之间的区别主要是：

| 参数                | RS232    | RS485          | RS422    |
| ------------------- | -------- | -------------- | -------- |
| 传输方式            | 单端参数 | 差分传输       | 差分传输 |
| 主机数量（个）      | 1        | 32（单位负载） | 1        |
| 从机数量（个）      | 1        | 32（单位负载） | 10       |
| 工作模式            | 全双工   | 半双工         | 全双工   |
| 最大传输距离（m）   | 20       | 1200           | 1200     |
| 最大传输速率（bps） | 20k      | 50m            | 10m      |



## RS232

RS232和串口通信一样，只能实现点对点的通信。

RS232接口，按照引脚个数分可以分为：9针（目前最为常见）、25针（目前非常少见）。

下面是常见的9针公口接口。从针数多的一行，顺时针数分为1-9引脚。

![](E:\JavaLeaningDoc\picture\rs232_9_pins_connector_male.jpg)

下面是常见的9针母口接口。从针数多的一行，逆时针数分为1-9引脚。

![](E:\JavaLeaningDoc\picture\rs232_9_pins_connector_female.jpg)

### 引脚含义

此处介绍，最常用的9针的RS232的每一个引脚的具体位置和含义。

| RS232引脚编号 | 引脚名缩写 | 引脚名全称          | 信号传输方向 |
| ------------- | ---------- | ------------------- | ------------ |
| 1             | DCD        | Data Carrier Detect | <—- 接收     |
| 2             | RXD        | Receive Data        | <—- 接收     |
| 3             | TXD        | Transmit Data       | —-> 发送     |
| 4             | DTR        | Data Terminal Ready | —-> 发送     |
| 5             | GND        | System GRounD       | —-           |
| 6             | DSR        | Data Set Ready      | <—- 接收     |
| 7             | RTS        | Request to Send     | —-> 接收     |
| 8             | CTS        | Clear to Send       | <—- 发送     |
| 9             | RI         | Ring Indicator      | <—- 发送     |

正常情况下，两个RS232接口，一个公口和母口，如前面的介绍，直接对应的插上互联就可以使用了。

对于完整的通信逻辑可以这么简单接收：

1. A先设置RTS为1，表示要发数据给B
2. B检测到了RTS为1，就看看自己是否已经准备好：如果准备好，就设置CTS为1表示A可以发送数据给我B了；如果没有准备好，那就继续处理需要处理的事情，比如缓存满了，尽快去搬移数据。弄完了，再去设置CTS为1，让A发送数据过来。
3. A发现CTS为1了，就开发发送数据给B。
4. A每发送一次数据给B之前，都继续上面的逻辑，就是先检测CTS是否为1，如果不是1，继续等待，如果是1，就发送数据。
5. A把所有数据都发送完毕了，就去设置为RTS为0，表示数据发送完了。B也就不会再去准备接受数据了。

### 简化连接

有时候，为了简化数据传输，仅仅**使用最基本的3根引脚**，即可实现数据传输了。

常见的有：不考虑流控制（握手协议），直接Rx / Tx 数据线和接地，只需要用到：

- 引脚2==RxD==接受数据
- 引脚3==TxD==发送数据
- 引脚5==GND==接地

当然普通的串口通信也是这3根线。

![](E:\JavaLeaningDoc\picture\dce_dte_3_pin_connection.jpg)

### 转换方法

对与普通的单片机（使用串口通信的TTL电平）使用232通信，只需要在原来的串口通讯基础上加一个电平转换芯片，例如MAX232，这样即可将其TTL电平转换为RS232电平

![](E:\JavaLeaningDoc\picture\2023-9-24 21-23-18.png)

### RS232电平

RS232属于全双工通信。对于普通的TTL电平来说，RS232电平电压更高。高电平通常为3V 到15V，低电平通常为-3V 到-15V。

所以它相较于普通的串口通信TTL电平来说 最大的好处是 抗干扰能力增强了，所以传输距离更长，为15m。



## RS485

RS485相较于普通的串口通信、RS232通信来说，它的传输类型使用了差分信号传输。

RS485只需要两个线，分为A、B。

**当其信号 A>B 时，表示逻辑0。 当B>A 时，表示逻辑1。**

*特别注意:千万不要以为RS485中的逻辑1就是B>A,逻辑0就是A>B，这是错误的！*

简而言之，当一端的信号被交换到了另外一端则为 0 ，回到同端则为1。

![](E:\JavaLeaningDoc\picture\2023-9-24 21-42-15.png)

RS485，也可以不接地线，不影响传输，但会影响抗干扰能力。

RS485传输距离可达1200m。

RS485一般为半双工通信。在同一时间要么只能发送数据，要么只能接收数据。

RS485可以实现一主多从，可以实现与很多数据通信。 

### 简化连接

通常RS485没有固定的简化接法。但是多数情况下是 A =  4、6引脚，B= 1、9引脚，G（地线）= 5引脚。

![](E:\JavaLeaningDoc\picture\1673429541660522.png)

## RS422

RS422是RS485的升级版，它使用4线缆设计，解决了RS485的半双工问题，实现了全双工通信。同样采用差分信号传输。

### 引脚定义

RS422最少需要4线连接，分别是TxD+、TxD-，和Rx+、Rx-。

对应DB9接口引脚： RxD- = 1引脚，RxD+ = 6引脚， TxD+ = 4引脚，TxD- = 9引脚，G = 5引脚。

![](E:\JavaLeaningDoc\picture\2023-9-24 21-58-13.png)

### 接线口诀

RS-422的接线口诀

Y=T+

Z=T-

A=R+

B=R-
